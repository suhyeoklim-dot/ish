<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì„±ì  ìˆœìœ„ ê³„ì‚°ê¸° (Firebase)</title>
<style>
body { font-family: Arial, sans-serif; background:#f6f6f6; display:flex; justify-content:center; align-items:flex-start; padding-top:30px; }
.container { background:#fff; padding:30px; border-radius:12px; width:480px; max-height:95vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
h1 { text-align:center; }
input { width:100%; padding:10px; margin:6px 0; border-radius:5px; border:1px solid #ccc; }
.error { color:red; font-size:13px; margin-top:-4px; margin-bottom:8px; display:none; }
button { width:100%; padding:10px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; font-size:16px; margin-top:10px; }
button:hover { background:#45a049; }
.result { margin-top:20px; font-size:16px; line-height:1.6; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f0f0f0; }
</style>
</head>
<body>

<div class="container">
  <h1>ì„±ì  ìˆœìœ„ ê³„ì‚°ê¸°</h1>
  <p>í•™ë²ˆê³¼ ì´ë¦„, ê° ê³¼ëª© ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>

  <input type="text" id="studentIdName" placeholder="ì˜ˆ: 22222 ê¹€ì¶˜ì">

  <div id="inputs"></div>

  <button id="saveBtn">ìˆœìœ„ í™•ì¸</button>

  <div class="result" id="result"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ğŸ”§ Firebase ì„¤ì • â†’ ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´
const firebaseConfig = {
  apiKey: "AIzaSyBq02FMgQeRNhDPTfdg0jZHVTYswpjpHvM",
  authDomain: "ishh-7b11e.firebaseapp.com",
  projectId: "ishh-7b11e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ê³¼ëª© ì •ì˜
const subjects = [
  { id: "korean", name: "êµ­ì–´" },
  { id: "math", name: "ìˆ˜í•™" },
  { id: "english", name: "ì˜ì–´" },
  { id: "physics", name: "ë¬¼ë¦¬" },
  { id: "chemistry", name: "í™”í•™" },
  { id: "biology", name: "ìƒëª…" },
  { id: "earth", name: "ì§€êµ¬" },
  { id: "prob", name: "í™•í†µ" },
  { id: "japanese", name: "ì¼ë³¸ì–´" }
];

// ì…ë ¥ í•„ë“œ ìƒì„±
const inputContainer = document.getElementById("inputs");
subjects.forEach(sub => {
  inputContainer.innerHTML += `
    <div>
      <input type="number" id="${sub.id}" placeholder="${sub.name} ì ìˆ˜">
      <div class="error" id="${sub.id}-error">${sub.name} ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”.</div>
    </div>
  `;
});

// ì €ì¥ & ê³„ì‚° ë²„íŠ¼
document.getElementById("saveBtn").onclick = async () => {
  const studentIdName = document.getElementById("studentIdName").value.trim();
  if (!studentIdName) { alert("í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }

  let valid = true;
  const scores = {};
  subjects.forEach(sub => {
    const val = Number(document.getElementById(sub.id).value);
    const errorMsg = document.getElementById(sub.id + "-error");
    if (isNaN(val) || val < 0 || val > 100) {
      errorMsg.style.display = "block";
      valid = false;
    } else {
      errorMsg.style.display = "none";
      scores[sub.id] = val;
    }
  });
  if (!valid) return;

  const total = Object.values(scores).reduce((a,b)=>a+b,0);
  const avg = (total/subjects.length).toFixed(2);

  // Firestoreì— ì €ì¥ (ê°™ì€ ì´ë¦„ì´ë©´ ë®ì–´ì“°ê¸°)
  await setDoc(doc(db, "students", studentIdName), { scores, total, avg });

  showMyResult(studentIdName);
}

// Firestoreì—ì„œ ëª¨ë“  í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function getAllStudents() {
  const querySnap = await getDocs(collection(db, "students"));
  const students = [];
  querySnap.forEach(docSnap => {
    students.push({ name: docSnap.id, ...docSnap.data() });
  });
  return students;
}

// ë‚´ ì ìˆ˜ + ë“±ìˆ˜ í‘œì‹œ
async function showMyResult(studentIdName) {
  const students = await getAllStudents();

  // ê³¼ëª©ë³„ ë“±ìˆ˜ ê³„ì‚°
  const subjectRanks = {};
  subjects.forEach(sub => {
    const sorted = [...students].sort((a,b)=>b.scores[sub.id]-a.scores[sub.id]);
    sorted.forEach((stu, idx) => {
      if (!subjectRanks[stu.name]) subjectRanks[stu.name] = {};
      subjectRanks[stu.name][sub.id] = idx + 1;
    });
  });

  // ì´ì  ìˆœìœ„
  students.sort((a,b)=>b.total - a.total);
  const totalRank = students.findIndex(s=>s.name===studentIdName)+1;
  const me = students.find(s=>s.name===studentIdName);

  if (!me) { document.getElementById("result").innerHTML="<p>í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

  document.getElementById("result").innerHTML = `
    <b>${totalRank}ìœ„ - ${me.name}</b><br>
    ì´ì : ${me.total}, í‰ê· : ${me.avg}<br>
    <table>
      <tr><th>ê³¼ëª©</th>${subjects.map(s=>`<th>${s.name}</th>`).join("")}</tr>
      <tr><td>ì ìˆ˜</td>${subjects.map(s=>`<td>${me.scores[s.id]}</td>`).join("")}</tr>
      <tr><td>ë“±ìˆ˜</td>${subjects.map(s=>`<td>${subjectRanks[me.name][s.id]}ìœ„</td>`).join("")}</tr>
    </table>
  `;
}
</script>

</body>
</html>
